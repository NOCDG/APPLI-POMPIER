name: CI/CD FEUILLE_GARDE (Vite)

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  actions: read

env:
  PY_VERSION: "3.11"
  NODE_VERSION: "20"

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install deps
        run: npm ci

      - name: Build (Vite)
        run: npm run build

      - name: Vérifier sortie Vite
        run: |
          ls -lAh .
          ls -lAh dist

      - name: Upload artifact frontend
        uses: actions/upload-artifact@v4
        with:
          name: frontend
          path: dist
          if-no-files-found: error
          retention-days: 7

  build-backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VERSION }}

      - name: Install deps (liste)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip freeze | sed -e 's/^/  - /'

      - name: Lister backend
        run: ls -lAh .

      - name: Upload artifact backend
        uses: actions/upload-artifact@v4
        with:
          name: backend
          path: .
          if-no-files-found: error
          retention-days: 7

  deploy:
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    steps:
      - name: Download backend
        uses: actions/download-artifact@v4
        with:
          name: backend
          path: backend

      - name: Download frontend
        uses: actions/download-artifact@v4
        with:
          name: frontend
          path: frontend_out

      - name: Vérifier téléchargements
        run: |
          ls -lAh backend
          ls -lAh frontend_out

      - name: SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ secrets.SSH_PORT }}" -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Synchroniser backend → serveur
        run: |
          rsync -az --delete backend/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/opt/feuille-garde/app/

      - name: Synchroniser frontend (Vite dist) → serveur
        run: |
          rsync -az --delete frontend_out/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/opt/feuille-garde/frontend_build/

      - name: Déployer .env prod
        run: |
          printf "%s\n" "${{ secrets.ENV_PROD }}" | ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cat > /opt/feuille-garde/app/.env && chmod 600 /opt/feuille-garde/app/.env"

      # Étape HTTPS idempotente (installe certbot si besoin, émet/renouvelle le certif, configure la redirection)
      - name: Configurer HTTPS (Let's Encrypt)
        if: ${{ secrets.DOMAIN != '' && secrets.LETSENCRYPT_EMAIL != '' }}
        run: |
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} bash -lc '
            set -euo pipefail
            DOMAIN="${{ secrets.DOMAIN }}"
            DOMAIN_ALT="${{ secrets.DOMAIN_ALT }}"
            EMAIL="${{ secrets.LETSENCRYPT_EMAIL }}"

            # Installer certbot si absent
            if ! command -v certbot >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y certbot python3-certbot-nginx
            fi

            # Assurer une conf Nginx minimale HTTP (si pas déjà faite)
            if [ ! -f /etc/nginx/sites-available/feuille_garde ]; then
              sudo tee /etc/nginx/sites-available/feuille_garde >/dev/null <<NGINX
server {
    listen 80;
    server_name ${DOMAIN} ${DOMAIN_ALT};

    root /opt/feuille-garde/frontend_build;
    index index.html;

    location / {
        try_files \$uri /index.html;
    }

    location /api {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
    }
}
NGINX
              sudo ln -sf /etc/nginx/sites-available/feuille_garde /etc/nginx/sites-enabled/feuille_garde
              sudo nginx -t && sudo systemctl restart nginx
            else
              # Mettre à jour server_name si nécessaire
              sudo sed -i -e "s/server_name .*/server_name ${DOMAIN} ${DOMAIN_ALT};/" /etc/nginx/sites-available/feuille_garde || true
              sudo nginx -t && sudo systemctl reload nginx
            fi

            # Émission (ou skip si déjà présent) + redirection auto
            if [ -d "/etc/letsencrypt/live/${DOMAIN}" ] && [ -f "/etc/letsencrypt/live/${DOMAIN}/fullchain.pem" ]; then
              echo "[LE] Certificat déjà présent pour ${DOMAIN} → skip émission."
            else
              if [ -n "${DOMAIN_ALT}" ]; then
                sudo certbot --nginx -n --agree-tos --email "${EMAIL}" -d "${DOMAIN}" -d "${DOMAIN_ALT}" --redirect
              else
                sudo certbot --nginx -n --agree-tos --email "${EMAIL}" -d "${DOMAIN}" --redirect
              fi
            fi

            # Test renouvellement (dry-run)
            sudo certbot renew --dry-run || true
          '

      - name: Redémarrer backend + recharger Nginx
        run: |
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} 'bash -lc "/opt/feuille-garde/bin/post_deploy.sh"'
