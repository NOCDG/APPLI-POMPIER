name: CI/CD FEUILLE_GARDE (Vite)

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  actions: read

env:
  PY_VERSION: "3.11"
  NODE_VERSION: "20"

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4
  
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
  
      # ⚠️ Si tu as un package-lock.json → garde npm ci
      # Si tu n'as PAS de package-lock.json → remplace par "npm install"
      - name: Install deps
        run: npm ci
  
      - name: Build (Vite)
        run: npm run build
  
      - name: Debug sortie
        run: |
          pwd
          ls -lAh .
          ls -lAh dist || true
  
      - name: Vérification stricte (doit exister)
        run: |
          test -d dist || { echo "❌ Pas de dossier dist : build absent/échoué (ou mauvais dossier)."; exit 1; }
  
      - name: Upload artifact frontend
        uses: actions/upload-artifact@v4
        with:
          name: frontend
          path: frontend/dist
          if-no-files-found: error
          retention-days: 7


  build-backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VERSION }}

      - name: Install deps (liste)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip freeze | sed -e 's/^/  - /'

      - name: Lister backend
        run: ls -lAh .

      - name: Upload artifact backend
        uses: actions/upload-artifact@v4
        with:
          name: backend
          path: .
          if-no-files-found: error
          retention-days: 7

  deploy:
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    env:
      DOMAIN: ${{ secrets.DOMAIN }}
      DOMAIN_ALT: ${{ secrets.DOMAIN_ALT }}
      LETSENCRYPT_EMAIL: ${{ secrets.LETSENCRYPT_EMAIL }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      ENV_PROD: ${{ secrets.ENV_PROD }}
    steps:
      - name: Download backend
        uses: actions/download-artifact@v4
        with:
          name: backend
          path: backend

      - name: Download frontend
        uses: actions/download-artifact@v4
        with:
          name: frontend
          path: frontend_out

      - name: Vérifier téléchargements
        run: |
          ls -lAh backend
          ls -lAh frontend_out

      - name: SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${SSH_PORT}" -H "${SSH_HOST}" >> ~/.ssh/known_hosts

      - name: Synchroniser backend → serveur
        run: |
          rsync -az --delete backend/ ${SSH_USER}@${SSH_HOST}:/opt/feuille-garde/app/

      - name: Synchroniser frontend (Vite dist) → serveur
        run: |
          rsync -az --delete frontend_out/ ${SSH_USER}@${SSH_HOST}:/opt/feuille-garde/frontend_build/

      - name: Déployer .env prod
        run: |
          printf "%s\n" "${ENV_PROD}" | ssh -p "${SSH_PORT}" ${SSH_USER}@${SSH_HOST} "cat > /opt/feuille-garde/app/.env && chmod 600 /opt/feuille-garde/app/.env"

      - name: Configurer HTTPS (Let's Encrypt) — simplifié
        if: ${{ env.DOMAIN != '' && env.LETSENCRYPT_EMAIL != '' }}
        run: |
          ssh -p "${SSH_PORT}" ${SSH_USER}@${SSH_HOST} bash -lc '
            set -euo pipefail
            DOMAIN="${DOMAIN}"
            DOMAIN_ALT="${DOMAIN_ALT}"
            EMAIL="${LETSENCRYPT_EMAIL}"

            if ! command -v certbot >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y certbot python3-certbot-nginx
            fi

            if [ ! -f /etc/nginx/sites-available/feuille_garde ]; then
              echo "❌ /etc/nginx/sites-available/feuille_garde introuvable. Crée la conf HTTP de base avant HTTPS."
              exit 1
            fi

            sudo sed -i -E "s/server_name .*/server_name ${DOMAIN} ${DOMAIN_ALT};/" /etc/nginx/sites-available/feuille_garde || true
            sudo nginx -t && sudo systemctl reload nginx

            if [ -d "/etc/letsencrypt/live/${DOMAIN}" ] && [ -f "/etc/letsencrypt/live/${DOMAIN}/fullchain.pem" ]; then
              echo "[LE] Certificat déjà présent pour ${DOMAIN} → skip émission."
            else
              if [ -n "${DOMAIN_ALT}" ]; then
                sudo certbot --nginx -n --agree-tos --email "${EMAIL}" -d "${DOMAIN}" -d "${DOMAIN_ALT}" --redirect
              else
                sudo certbot --nginx -n --agree-tos --email "${EMAIL}" -d "${DOMAIN}" --redirect
              fi
            fi

            sudo certbot renew --dry-run || true
          '

      - name: Redémarrer backend + recharger Nginx
        run: |
          ssh -p "${SSH_PORT}" ${SSH_USER}@${SSH_HOST} 'bash -lc "/opt/feuille-garde/bin/post_deploy.sh"'
